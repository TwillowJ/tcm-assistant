import streamlit as st
import os
from llm_service import TCMAnalyzer

# é¡µé¢é…ç½®
st.set_page_config(
    page_title="ä¸­åŒ»æ™ºèƒ½å°åŠ©æ‰‹",
    page_icon="ğŸ¥",
    layout="wide"
)

# ä¸»æ ‡é¢˜
st.title("ğŸ¥ ä¸­åŒ»æ™ºèƒ½å°åŠ©æ‰‹")
st.markdown("---")

# ç®€ä»‹
st.markdown("""
### æ¬¢è¿ä½¿ç”¨ä¸­åŒ»æ™ºèƒ½å°åŠ©æ‰‹
æœ¬åº”ç”¨åŸºäºäººå·¥æ™ºèƒ½æŠ€æœ¯ï¼Œä»ä¸­åŒ»è§’åº¦åˆ†ææ‚¨çš„èº«ä½“ä¸é€‚ç—‡çŠ¶ï¼Œå¹¶æä¾›ä¸ªæ€§åŒ–çš„å…»ç”Ÿå»ºè®®ã€‚

**ä½¿ç”¨è¯´æ˜ï¼š**
1. åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­è¯¦ç»†æè¿°æ‚¨çš„ä¸é€‚ç—‡çŠ¶
2. ç‚¹å‡»"å¼€å§‹åˆ†æ"æŒ‰é’®
3. ç­‰å¾…AIåˆ†æå¹¶æŸ¥çœ‹å»ºè®®

âš ï¸ **å…è´£å£°æ˜ï¼š** æœ¬åº”ç”¨ä»…æä¾›å‚è€ƒå»ºè®®ï¼Œä¸èƒ½æ›¿ä»£ä¸“ä¸šåŒ»ç–—è¯Šæ–­ã€‚å¦‚æœ‰ä¸¥é‡ä¸é€‚ï¼Œè¯·åŠæ—¶å°±åŒ»ã€‚
""")

st.markdown("---")

# ç—‡çŠ¶è¾“å…¥åŒºåŸŸ
st.subheader("ğŸ“ è¯·æè¿°æ‚¨çš„ç—‡çŠ¶")

# ä½¿ç”¨æ–‡æœ¬åŒºåŸŸè®©ç”¨æˆ·è¾“å…¥ç—‡çŠ¶
symptoms = st.text_area(
    "ç—‡çŠ¶æè¿°",
    placeholder="ä¾‹å¦‚ï¼šæœ€è¿‘ç»å¸¸æ„Ÿåˆ°ç–²åŠ³ï¼Œå®¹æ˜“å‡ºæ±—ï¼Œæ™šä¸Šç¡çœ è´¨é‡ä¸å¥½ï¼Œå¶å°”ä¼šæœ‰å¤´æ™•...",
    height=150,
    help="è¯·å°½å¯èƒ½è¯¦ç»†åœ°æè¿°æ‚¨çš„ç—‡çŠ¶ï¼ŒåŒ…æ‹¬æŒç»­æ—¶é—´ã€å‘ç”Ÿé¢‘ç‡ã€ä¼´éšç—‡çŠ¶ç­‰"
)

# æ·»åŠ ä¸€äº›å¯é€‰çš„è¡¥å……ä¿¡æ¯
st.markdown("#### è¡¥å……ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰")

col1, col2, col3 = st.columns(3)

with col1:
    age = st.number_input("å¹´é¾„", min_value=1, max_value=120, value=30)

with col2:
    gender = st.selectbox("æ€§åˆ«", ["ç”·", "å¥³", "ä¸æ–¹ä¾¿é€éœ²"])

with col3:
    duration = st.selectbox(
        "ç—‡çŠ¶æŒç»­æ—¶é—´",
        ["1-3å¤©", "1å‘¨å·¦å³", "2-4å‘¨", "1-3ä¸ªæœˆ", "3ä¸ªæœˆä»¥ä¸Š"]
    )

st.markdown("---")

# åˆ†ææŒ‰é’®
analyze_button = st.button("ğŸ” å¼€å§‹åˆ†æ", type="primary", use_container_width=True)

# ç»“æœå±•ç¤ºåŒºåŸŸ
if analyze_button:
    if not symptoms.strip():
        st.error("âŒ è¯·å…ˆè¾“å…¥ç—‡çŠ¶æè¿°")
    else:
        try:
            # åˆå§‹åŒ–åˆ†æå™¨
            analyzer = TCMAnalyzer()

            # æ˜¾ç¤ºåŠ è½½çŠ¶æ€å¹¶è°ƒç”¨LLM API
            with st.spinner("ğŸ¤– AIæ­£åœ¨åˆ†ææ‚¨çš„ç—‡çŠ¶ï¼Œè¯·ç¨å€™..."):
                # ä½¿ç”¨æµå¼è¾“å‡ºè·å¾—æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
                result_placeholder = st.empty()
                full_response = ""

                # æµå¼è·å–åˆ†æç»“æœ
                for chunk in analyzer.analyze_streaming(
                    symptoms=symptoms,
                    age=int(age),
                    gender=gender,
                    duration=duration
                ):
                    full_response += chunk
                    result_placeholder.markdown(full_response)

            st.success("âœ… åˆ†æå®Œæˆï¼")

            # æ·»åŠ åˆ†éš”çº¿
            st.markdown("---")

            # æç¤ºä¿¡æ¯
            st.info("ğŸ’¡ **æ¸©é¦¨æç¤ºï¼š** ä»¥ä¸Šå»ºè®®ä»…ä¾›å‚è€ƒï¼Œå…·ä½“æƒ…å†µè¯·å’¨è¯¢ä¸“ä¸šä¸­åŒ»å¸ˆã€‚")

        except Exception as e:
            st.error(f"âŒ åˆ†æè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼š{str(e)}")
            st.info("ğŸ’¡ è¯·æ£€æŸ¥ï¼š\n1. æ˜¯å¦å·²é…ç½®OPENAI_API_KEY\n2. APIå¯†é’¥æ˜¯å¦æœ‰æ•ˆ\n3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸")

# ä¾§è¾¹æ 
with st.sidebar:
    st.markdown("### å…³äº")
    st.info("""
    **ä¸­åŒ»æ™ºèƒ½å°åŠ©æ‰‹ v1.0**

    æœ¬åº”ç”¨ç»“åˆä¼ ç»Ÿä¸­åŒ»ç†è®ºä¸ç°ä»£AIæŠ€æœ¯ï¼Œ
    ä¸ºæ‚¨æä¾›å¥åº·å…»ç”Ÿå»ºè®®ã€‚
    """)

    st.markdown("### å¸¸è§é—®é¢˜")
    with st.expander("å¦‚ä½•è·å¾—æ›´å‡†ç¡®çš„å»ºè®®ï¼Ÿ"):
        st.write("è¯·å°½å¯èƒ½è¯¦ç»†åœ°æè¿°ç—‡çŠ¶ï¼ŒåŒ…æ‹¬å…·ä½“è¡¨ç°ã€æŒç»­æ—¶é—´ã€å‘ç”Ÿé¢‘ç‡ç­‰ä¿¡æ¯ã€‚")

    with st.expander("å»ºè®®çš„å¯ä¿¡åº¦å¦‚ä½•ï¼Ÿ"):
        st.write("æœ¬åº”ç”¨åŸºäºå¤§è¯­è¨€æ¨¡å‹æä¾›å»ºè®®ï¼Œä»…ä¾›å‚è€ƒã€‚ä¸¥é‡ç—‡çŠ¶è¯·åŠæ—¶å°±åŒ»ã€‚")

    with st.expander("æˆ‘çš„æ•°æ®å®‰å…¨å—ï¼Ÿ"):
        st.write("æ‚¨çš„è¾“å…¥ä»…ç”¨äºç”Ÿæˆå»ºè®®ï¼Œä¸ä¼šè¢«æ°¸ä¹…å­˜å‚¨ã€‚")

# é¡µè„š
st.markdown("---")
st.markdown(
    "<div style='text-align: center; color: gray;'>Â© 2025 ä¸­åŒ»æ™ºèƒ½å°åŠ©æ‰‹ | Powered by Streamlit & AI</div>",
    unsafe_allow_html=True
)